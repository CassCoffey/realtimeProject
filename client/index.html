<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://npmcdn.com/babel-core@5.8.38/browser.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
    <script type="text/babel" >
        "use strict";
		var canvas;
		var ctx;
		var user;
		
		let socket;
		
		var board = [
			[null, null, null],
			[null, null, null],
			[null, null, null]
		];
    
		const connectSocket = (e) => {
			socket = io.connect();
			
			user = document.querySelector("#username").value;
			if (!user) {
					user = 'unknown';
			}
			
			socket.on('connect', () => {
				console.log('connecting');
				socket.emit('join', {name: user});
			});
			
			socket.on('connected', () => {				
				document.querySelector("#login").style.display = "none";
				document.querySelector("#game").style.display = "block";
				
				draw();
			});
			
			socket.on('updateRoomInfo', (data) => {
				document.querySelector("#roomInfo").innerHTML = `Room: ${data.name}, Player One: ${data.playerOne}, Player Two: ${data.playerTwo}`;
			});
			
			socket.on('updateBoard', (data) => {
				board = data.board;
				draw();
			});
		};
		
		const draw = () => {
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			
			drawBoard();
			
			for (var x = 0; x < 3; x++) {
				for (var y = 0; y < 3; y++) {
					if (board[x][y] === 'x') {
						drawX(x,y);
					}
					else if (board[x][y] === 'o') {
						drawO(x,y);
					}
				}
			}
		}
		
		const drawBoard = () => {
			var width = canvas.width;
			var height = canvas.height;
			var sectionWidth = width / 3;
			var sectionHeight = width / 3;
			
			for (var i = 1; i < 3; i++)
			{
				let curX = i * sectionWidth;
				let curY = i * sectionHeight;
				ctx.beginPath();
				ctx.moveTo(curX,0);
				ctx.lineTo(curX,height);
				ctx.stroke();
				
				ctx.beginPath();
				ctx.moveTo(0, curY);
				ctx.lineTo(width, curY);
				ctx.stroke();
			}
		}
		
		const drawX = (x, y) => {
			var width = canvas.width;
			var height = canvas.height;
			var sectionWidth = width / 3;
			var sectionHeight = width / 3;
			var boardX = x * sectionWidth;
			var boardY = y * sectionHeight;
			
			ctx.beginPath();
			ctx.moveTo(boardX,boardY);
			ctx.lineTo(boardX + sectionWidth,boardY + sectionHeight);
			ctx.stroke();
			
			ctx.beginPath();
			ctx.moveTo(boardX,boardY + sectionHeight);
			ctx.lineTo(boardX + sectionWidth,boardY);
			ctx.stroke();
		}
		
		const drawO = (x, y) => {
			var width = canvas.width;
			var height = canvas.height;
			var sectionWidth = width / 3;
			var sectionHeight = width / 3;
			var boardX = x * sectionWidth;
			var boardY = y * sectionHeight;
			
			ctx.beginPath();
			ctx.arc(boardX + (sectionWidth/2),boardY + (sectionHeight/2),sectionWidth/2,0,2*Math.PI);
			ctx.stroke();
		}
		
		const getMousePos = (e) => {
			var rect = canvas.getBoundingClientRect();
			return {
				x: e.clientX - rect.left,
				y: e.clientY - rect.top
			};
		}
		
		const doMouseDown = (e) => {
			var mousePos = getMousePos(e);
			var width = canvas.width;
			var height = canvas.height;
			var sectionWidth = width / 3;
			var sectionHeight = width / 3;
			
			var x = Math.floor(mousePos.x / sectionWidth);
			var y = Math.floor(mousePos.y / sectionHeight);
			
			socket.emit('makeMove', {x: x, y: y});
		}
		
		const init = () => {
			canvas = document.getElementById("mainCanvas");
			ctx = canvas.getContext("2d");
			const connect = document.querySelector("#connect");
			connect.addEventListener('click', connectSocket);
			canvas.addEventListener('click', function (e) {
				doMouseDown(e);
			}, false);
		};
		
		window.onload = init;
    </script>
	
	<style>
		#game {
			display: none;
		}
		canvas {
			display: block;
		}
	</style>
</head>
<body>
	<div id="login">
		<label for="user">Username:</label>
		<input id="username" name="user" type="text"/>
		<input id="connect" type='button' value='connect'/>
	</div>
	<div id="game">
		<p id="roomInfo"></p>
		<canvas id="mainCanvas" width="640" height="640"></canvas>
	</div>
</body>
</html>